<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>PDB Viewer</title>
    <script src="https://cdn.jsdelivr.net/npm/ngl@0.10.4/dist/ngl.js"></script>
    <style>
        body { font-family: Arial, sans-serif; }
        #viewport { width: 100%; height: 500px; }
        #info { margin-top: 10px; }
    </style>
</head>
<body>
    <h1>PDB Viewer</h1>
    <label for="pdbSelect">Select PDB:</label>
    <select id="pdbSelect"></select>
    <label for="rowSelect">Select Row:</label>
    <select id="rowSelect"></select>
    <div id="viewport"></div>
    <div id="info"></div>

    <script>
        // Initialize NGL Stage
        const stage = new NGL.Stage("viewport");

        // Function to fetch and parse CSV data
        function fetchCSVData(url) {
            return fetch(url)
                .then(response => response.text())
                .then(text => parseCSV(text));
        }

    	// Function to parse CSV text
	function parseCSV(text) {
	    const rows = text.trim().split("\n");
	    const headers = rows[0].split(",");
	    return rows.slice(1).map(row => {
		const values = row.split(",");
		return headers.reduce((obj, header, index) => {
		    // Parse the 'c' column as JSON
		    if (header === "c") {
			try {
			    obj[header] = JSON.parse(values[index]);
			} catch (e) {
			    console.error("Error parsing JSON in 'c' column:", values[index], e);
			    obj[header] = [];
			}
		    } else {
			obj[header] = values[index];
		    }
		    return obj;
		}, {});
	    });
	}


        // Function to populate PDB Select Dropdown
        function populatePDBSelect(pdbFiles) {
            const pdbSelect = document.getElementById("pdbSelect");
            pdbFiles.forEach(file => {
                const option = document.createElement("option");
                option.text = file;
                option.value = file;
                pdbSelect.add(option);
            });

            // Set up event listener for PDB selection
            pdbSelect.addEventListener('change', function() {
                loadPDB(this.value);
            });

            // Initialize viewer with the first PDB file
            if (pdbFiles.length > 0) {
                loadPDB(pdbFiles[0]);
            }
        }

        // Load the selected PDB file
        function loadPDB(file) {
            stage.removeAllComponents();
            stage.loadFile(`PDB/${file}`).then(component => {
                component.addRepresentation("cartoon");
                component.autoView();
                updateRowSelect(file);
            });
        }

        // Update the row select options based on the selected PDB
        function updateRowSelect(pdbFile) {
            const uniprotID = pdbFile.split('.')[0];
            const rows = csvData.filter(row => row.UniprotID === uniprotID);

            const rowSelect = document.getElementById("rowSelect");
            rowSelect.innerHTML = ''; // Clear existing options
            rows.forEach((row, index) => {
                const option = document.createElement("option");
                option.text = `ENT-ID: ${row["ENT-ID"]}, i: ${row.i}, j: ${row.j}`;
                option.value = index;
                rowSelect.add(option);
            });

            // Set up event listener for row selection
            rowSelect.addEventListener('change', function() {
                highlightResidues(rows[this.value]);
            });
        }

        // Highlight residues based on the selected row
        function highlightResidues(row) {
            const component = stage.compList[0];
            component.removeAllRepresentations();
            component.addRepresentation("cartoon");
            component.addRepresentation("spacefill", {
                sele: `${row.i}:${row["i-resname"]} or ${row.j}:${row["j-resname"]}`,
                color: "grey",
                radius: 2.0
            });
            component.addRepresentation("ball+stick", {
                sele: `${row.i}:${row["i-resname"]} or ${row.j}:${row["j-resname"]}`,
                color: "red"
            });
            component.addRepresentation("surface", {
                sele: row.c.map(id => `${id}`).join(' or '),
                color: "blue",
                opacity: 0.5
            });

            // Display information
            document.getElementById("info").innerHTML = `
                <strong>UniprotID:</strong> ${row.UniprotID}<br>
                <strong>ENT-ID:</strong> ${row["ENT-ID"]}<br>
                <strong>i:</strong> ${row.i} (${row["i-resname"]})<br>
                <strong>j:</strong> ${row.j} (${row["j-resname"]})<br>
                <strong>c:</strong> ${row.c.join(', ')}
            `;
        }

        // Load CSV data and initialize the viewer
        let csvData = [];
        fetchCSVData('pdb_info.csv').then(data => {
            csvData = data;
            const pdbFiles = [...new Set(csvData.map(row => `${row.UniprotID}.pdb`))];
            populatePDBSelect(pdbFiles);
        });

    </script>
</body>
</html>

